{% extends 'accounts/accounts_base.html' %}

{% block title %}Sales{% endblock %}

{% block content %}

<div class="container mt-4">
    <h2 class="mb-4">Sales</h2>

    <form method="POST" action="{{ url_for('accounting.add_sales') }}">
        <div class="form-group">
            <label for="customer_id">Select Customer</label>
            <select id="customer_id" name="customer_id" class="form-control" required>
                {% for customers in customers %}
                <option value="{{ customers.id }}">{{ customers.full_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="item_id">Item</label>
            <select id="item_id" name="item_id" class="form-control" required>
                {% for items in items %}
                <option value="{{ items.id }}">{{ items.category }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" class="form-control" min="1" required>
        </div>

        <div class="form-group">
            <label for="discount">Discount</label>
            <input type="number" id="discount" name="discount" class="form-control" min="0" value="0">
        </div>

        <div class="form-group">
            <label for="total_amount">Total Amount</label>
            <input type="text" id="total_amount" name="total_amount" class="form-control" readonly>
        </div>

        <button type="submit" class="btn btn-primary">Add Sale</button>
    </form>
</div>

<div class="container mt-4">
    <h3>Sales</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th>Customer</th>
                <th>Quantity</th>
                <th>Total Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales %}
            <tr>
                <td>{{ sale.product.name }}</td>
                <td>{{ sale.customer.full_name }}</td>
                <td>{{ sale.quantity }}</td>
                <td>{{ sale.total_amount }}</td>
                <td>{{ sale.sale_date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('item_id').addEventListener('change', function () {
    const itemId = this.value;

    // Fetch price configuration for the selected item
    fetch(`/get_price_config?item_id=${itemId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                const unitPrice = data.items.sale_price;
                document.getElementById('quantity').dataset.unitPrice = unitPrice;
                calculateTotal();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error fetching item price. Please try again.'); +
        });
});

document.getElementById('quantity').addEventListener('input', calculateTotal);
document.getElementById('discount').addEventListener('input', calculateTotal);

function calculateTotal() {
    const quantity = parseFloat(document.getElementById('quantity').value || 0);
    const unitPrice = parseFloat(document.getElementById('quantity').dataset.unitPrice || 0);
    const discount = parseFloat(document.getElementById('discount').value || 0);

    if (quantity > 0 && unitPrice > 0) {
        const total = (unitPrice * quantity) - discount;

        // Ensure the total is not negative
        document.getElementById('total_amount').value = total < 0 ? '0.00' : total.toFixed(2);
    } else {
        document.getElementById('total_amount').value = '';
    }
}
</script>

{% endblock %}
